# Система контроля фонда админа

## Обзор

Система контроля фонда админа обеспечивает полную прозрачность движения денег в системе Gepard. Админ всегда один, и у него есть следующие поля:

- `fund` - статичный фонд (например, 1000000 TMT)
- `fund_dynamic` - динамический фонд, который изменяется при операциях
- `total_earn` - общий заработок системы
- `fund_current` - вычисляемый атрибут, показывающий текущий фонд

## Принцип работы

### Основная формула
```
fund_current = fund_dynamic + все_деньги_в_системе
```

### Проверка баланса
```
fund_current == fund (должно всегда совпадать)
```

Если `fund_current` не равен `fund`, значит в системе есть ошибка или неучтенные деньги.

## Деньги в системе

Система учитывает все деньги в следующих местах:

### Операторы
- `cash` - касса оператора

### Водители
- `balance` - кошелек водителя
- `cash_client` - наличные от клиентов
- `cash_service` - наличные за услуги
- `cash_goods` - товары на руках
- `cash_company_balance` - наличные от заведений
- `cash_wallet` - за пополнение кошелька клиента
- `earning` - заработок водителя
- `earning_pending` - отложенный заработок

### Компании
- `credit_balance` - кредит компании
- `balance` - баланс компании
- `agregator_side_balance` - долг агрегатора

## Операции с фондом

### Пополнение кассы оператора
```
Админ.fund_dynamic (-сумма) → Оператор.cash (+сумма)
```

### Закрытие кассы оператора
```
Оператор.cash (-сумма) → Админ.fund_dynamic (+сумма)
```

## API Endpoints

### Получение информации о фонде
```
GET /api/owner/fund/info
```

### Проверка баланса
```
GET /api/owner/fund/balance-check
```

### Логи фонда
```
GET /api/owner/fund/logs
GET /api/owner/fund/logs/operators
GET /api/owner/fund/logs/tags
```

## Команды Artisan

### Проверка баланса
```bash
php artisan fund:check-balance
```

### Детальная проверка
```bash
php artisan fund:check-balance --detailed
```

## Логирование

Все операции с фондом записываются в таблицу `gp_admin_fund_logs`:

- `admin_id` - ID админа
- `amount` - сумма операции
- `old_fund_dynamic` - фонд до операции
- `new_fund_dynamic` - фонд после операции
- `tag` - тег операции
- `operator_id` - ID оператора (если применимо)
- `user_id` - ID пользователя, выполнившего операцию
- `user_type` - тип пользователя

## Особенности

1. **Касса оператора не делится** - все деньги в кассе оператора считаются как единое целое
2. **Фиксация при сдаче** - закрытие счетов водителя фиксируется только при сдаче кассиру
3. **Автоматическая проверка** - система автоматически проверяет баланс при каждой операции
4. **Детальное логирование** - все операции записываются с полной информацией

## Мониторинг

Для мониторинга состояния фонда используйте:

1. **Веб-интерфейс** - страница `/admin/fund`
2. **API** - endpoint `/api/owner/fund/balance-check`
3. **Команда** - `php artisan fund:check-balance`

## Устранение неполадок

Если `fund_current` не равен `fund`:

1. Проверьте логи фонда на наличие ошибок
2. Убедитесь, что все операции выполняются через правильные репозитории
3. Проверьте, что нет прямых изменений в базе данных
4. Используйте команду `fund:check-balance --detailed` для детального анализа

## Безопасность

- Все операции выполняются в транзакциях
- Проверка достаточности средств перед операциями
- Логирование всех действий
- Автоматическая проверка баланса
