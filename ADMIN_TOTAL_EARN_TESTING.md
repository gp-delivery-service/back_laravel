# Тестирование схемы изменения общего заработка админа

## Требования к логике:

1. **Общий заработок (total_earn) пополняется только двумя способами:**
   - При закрытии кассы водителя (списание с `gp_drivers.cash_service`)
   - При закрытии заказа с оплатой с баланса (комиссия агрегатора)

2. **Формула проверки:**
   ```
   total_earn = сумма всех списаний с cash_service + сумма всех комиссий с delivery_price
   ```

## Тестовые сценарии:

### 1. Закрытие кассы водителя
- **Действие:** Водитель закрывает кассу на 100 TMT, где:
  - `cash_client`: 30 TMT
  - `cash_service`: 50 TMT ← **ИМЕННО ОТСЮДА**
  - `cash_goods`: 20 TMT
- **Ожидаемый результат:** ✅
  - `total_earn` увеличивается на 50 TMT
  - В логах появляется запись с тегом `driver_cash_service_close`

### 2. Закрытие заказа с оплатой с баланса
- **Действие:** Водитель закрывает заказ с `delivery_price = 20 TMT`, `driver_fee = 25%`
- **Ожидаемый результат:** ✅
  - С баланса компании списывается: 20 TMT
  - Водителю начисляется: 15 TMT в `earning_pending`
  - `total_earn` увеличивается на 5 TMT (комиссия агрегатора)
  - В логах появляется запись с тегом `order_balance_commission`

### 3. Закрытие заказа с оплатой наличными (client)
- **Действие:** Водитель закрывает заказ с `delivery_pay = 'client'`
- **Ожидаемый результат:** ✅
  - `total_earn` НЕ изменяется
  - Комиссия начисляется в `cash_service` водителя

### 4. Закрытие заказа с оплатой наличными (cash)
- **Действие:** Водитель закрывает заказ с `delivery_pay = 'cash'`
- **Ожидаемый результат:** ✅
  - `total_earn` НЕ изменяется
  - Обработано при принятии вызова

### 5. Закрытие кассы без cash_service
- **Действие:** Водитель закрывает кассу, но у него нет средств в `cash_service`
- **Ожидаемый результат:** ✅
  - `total_earn` НЕ изменяется
  - Закрываются другие колонки кассы

## Проверка баланса:
- `total_earn` должен равняться сумме всех комиссий агрегатора
- Все изменения должны быть залогированы в `gp_admin_fund_logs`
- Теги логов должны соответствовать типу операции

## Критерии успешного тестирования:
✅ `total_earn` увеличивается только при списании с `cash_service`
✅ `total_earn` увеличивается только при комиссии с заказов с баланса
✅ Все изменения залогированы с правильными тегами
✅ Формула проверки выполняется
✅ Другие операции не влияют на `total_earn`
