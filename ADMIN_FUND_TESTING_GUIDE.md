# Руководство по тестированию фонда админа

## Сводная таблица всех случаев изменения фонда админа

| № | Действие | Метод | Изменения | Тег | Логи |
|---|----------|-------|-----------|-----|------|
| 1 | Админ пополняет кассу оператора | `addCashToOperator()` | `fund_dynamic`↓, касса оператора↑ | `admin_add_cash` | `gp_admin_fund_logs` + `gp_operator_balance_logs` |
| 2 | Админ пополняет кредит компании | `addCreditBalance()` (админ) | `fund_dynamic`↓, `credit_balance`↑ | `credit_balance_increase` | `gp_admin_fund_logs` + `gp_company_balance_logs` |
| 3 | Оператор пополняет кредит компании | `addCreditBalanceByOperator()` | `credit_balance`↑, `fund_dynamic` не изменяется | `operator_credit_balance_increase` | `gp_company_balance_logs` + `gp_operator_balance_logs` |
| 4 | Водитель принимает вызов (списание кредита) | `addCreditBalance()` (отрицат.) | `fund_dynamic`↑, `credit_balance`↓ | `credit_balance_close` | `gp_admin_fund_logs` + `gp_company_balance_logs` |
| 5 | Водитель принимает вызов (оплата с баланса) | `increaseTotalEarn()` | `total_earn`↑ (если трогается earning_pending) | `order_balance_commission` | `gp_admin_fund_logs` + `gp_company_balance_logs` + `gp_driver_balance_logs` |
| 6 | Водитель закрывает кассу (списание cash_service) | `increaseTotalEarn()` | `total_earn`↑ | `driver_cash_service_close` | `gp_admin_fund_logs` + `gp_driver_balance_logs` |
| 7 | Пополнение общего фонда | `topUpFund()` | `fund`↑, `fund_dynamic`↑ | `admin_top_up_fund` | `gp_admin_fund_logs` |

## Сценарии тестирования

### Сценарий 1: Пополнение кассы оператора
**Цель:** Проверить корректное списание с фонда админа при пополнении кассы оператора

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `cash` оператора
2. Админ пополняет кассу оператора на сумму 1000
3. Проверить изменения:
   - `fund_dynamic` админа уменьшился на 1000
   - `cash` оператора увеличился на 1000
4. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `admin_add_cash`
   - В `gp_operator_balance_logs` запись с тегом `admin_add_cash`

**Ожидаемый результат:** Фонд админа уменьшился, касса оператора увеличилась, логи корректны.

### Сценарий 2: Админ пополняет кредит компании
**Цель:** Проверить корректное списание с фонда при пополнении кредита админом

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `credit_balance` компании
2. Админ пополняет кредит компании на сумму 1500
3. Проверить изменения:
   - `fund_dynamic` админа уменьшился на 1500
   - `credit_balance` компании увеличился на 1500
4. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `credit_balance_increase`
   - В `gp_company_balance_logs` запись с тегом `credit_increase`

**Ожидаемый результат:** Фонд админа уменьшился, кредит компании увеличился, логи корректны.

### Сценарий 3: Оператор пополняет кредит компании
**Цель:** Проверить, что при пополнении кредита оператором фонд админа не изменяется

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `credit_balance` компании
   - `cash` оператора
2. Оператор пополняет кредит компании на сумму 800
3. Проверить изменения:
   - `fund_dynamic` админа НЕ изменился
   - `credit_balance` компании увеличился на 800
   - `cash` оператора уменьшился на 800
4. Проверить логи:
   - В `gp_company_balance_logs` запись с тегом `operator_credit_balance_increase`
   - В `gp_operator_balance_logs` запись с тегом `operator_credit_balance_increase`
   - В `gp_admin_fund_logs` НЕТ записей

**Ожидаемый результат:** Фонд админа не изменился, кредит компании увеличился, касса оператора уменьшилась, логи корректны.

### Сценарий 4: Водитель принимает вызов (списание кредита)
**Цель:** Проверить корректное пополнение фонда при списании кредита

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `credit_balance` компании
2. Создать заказ на сумму 800
3. Водитель принимает вызов (если у компании достаточно кредита)
4. Проверить изменения:
   - `fund_dynamic` админа увеличился на 800
   - `credit_balance` компании уменьшился на 800
5. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `credit_balance_close`
   - В `gp_company_balance_logs` запись с тегом `picked_up_cash`

**Ожидаемый результат:** Фонд админа увеличился, кредит компании уменьшился, логи корректны.

### Сценарий 5: Водитель принимает вызов (оплата с баланса)
**Цель:** Проверить корректное начисление комиссии при оплате с баланса

**Шаги:**
1. Записать начальные значения:
   - `total_earn` админа
   - `balance` компании
   - `earning_pending` водителя
2. Создать заказ с `delivery_pay = 'balance'` и `delivery_price = 500`
3. Водитель принимает вызов
4. Рассчитать комиссию (например, 20% = 100)
5. Проверить изменения:
   - `total_earn` админа увеличился на 100 (если трогается earning_pending)
   - `balance` компании уменьшился на 500
   - `earning_pending` водителя увеличился на 400
6. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `order_balance_commission`
   - В `gp_company_balance_logs` запись с тегом `order_closed`
   - В `gp_driver_balance_logs` запись с тегом `order_closed`

**Ожидаемый результат:** Заработок админа увеличился на комиссию, баланс компании уменьшился, логи корректны.

### Сценарий 6: Водитель закрывает кассу (списание cash_service)
**Цель:** Проверить корректное увеличение заработка при закрытии кассы

**Шаги:**
1. Записать начальные значения:
   - `total_earn` админа
   - `cash_service` водителя
2. Водитель имеет `cash_service` = 300
3. Оператор закрывает кассу водителя на сумму 200
4. Проверить изменения:
   - `total_earn` админа увеличился на 200
   - `cash_service` водителя уменьшился на 200
5. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `driver_cash_service_close`
   - В `gp_driver_balance_logs` запись с тегом `cash_close`

**Ожидаемый результат:** Заработок админа увеличился, касса водителя уменьшилась, логи корректны.

### Сценарий 7: Пополнение общего фонда
**Цель:** Проверить корректное пополнение общего фонда админа

**Шаги:**
1. Записать начальные значения:
   - `fund` админа
   - `fund_dynamic` админа
2. Админ пополняет общий фонд на сумму 2000
3. Проверить изменения:
   - `fund` админа увеличился на 2000
   - `fund_dynamic` админа увеличился на 2000
4. Проверить логи:
   - В `gp_admin_fund_logs` запись с тегом `admin_top_up_fund`

**Ожидаемый результат:** Оба фонда увеличились, логи корректны.

### Сценарий 8: Проверка операций без влияния на фонд
**Цель:** Проверить, что следующие операции НЕ влияют на фонд админа

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `total_earn` админа
2. Выполнить операции:
   - Водитель закрывает заказ
   - Водитель закрывает вызов
   - Оператор закрывает кассу
   - Увеличивается долг агрегатора
3. Проверить, что `fund_dynamic` и `total_earn` НЕ изменились

**Ожидаемый результат:** Фонд админа не изменился при этих операциях.

### Сценарий 8.1: Проверка закрытия кассы оператора (ИСПРАВЛЕНО)
**Цель:** Проверить, что при закрытии кассы оператора фонд админа НЕ изменяется

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `cash` оператора
2. Админ закрывает кассу оператора на сумму 300
3. Проверить изменения:
   - `fund_dynamic` админа НЕ изменился ✅
   - `cash` оператора уменьшился на 300
4. Проверить логи:
   - В `gp_admin_fund_logs` НЕТ записей ✅
   - В `gp_operator_balance_logs` запись с тегом `admin_close_cash`

**Ожидаемый результат:** Фонд админа не изменился, касса оператора уменьшилась, логи корректны.

### Сценарий 8.2: Проверка увеличения долга агрегатора (ИСПРАВЛЕНО)
**Цель:** Проверить, что при увеличении долга агрегатора фонд админа НЕ изменяется

**Шаги:**
1. Записать начальные значения:
   - `fund_dynamic` админа
   - `credit_balance` компании
   - `agregator_side_balance` компании
2. Создать заказ на сумму 2000 (больше чем кредит компании)
3. Водитель принимает вызов
4. Проверить изменения:
   - `fund_dynamic` админа НЕ изменился ✅
   - `agregator_side_balance` компании увеличился на 2000
5. Проверить логи:
   - В `gp_admin_fund_logs` НЕТ записей ✅
   - В `gp_company_balance_logs` запись с тегом `picked_up_cash`

**Ожидаемый результат:** Фонд админа не изменился, долг агрегатора увеличился, логи корректны.

### Сценарий 9: Проверка баланса фонда
**Цель:** Проверить, что фонд всегда сбалансирован

**Шаги:**
1. Выполнить несколько операций из сценариев выше
2. Проверить баланс фонда:
   ```php
   $admin = GpAdmin::first();
   $isBalanced = $admin->isFundBalanced();
   $difference = $admin->getFundDifference();
   ```
3. Проверить, что `isBalanced = true` и `difference = 0`

**Ожидаемый результат:** Фонд всегда остается сбалансированным.

### Сценарий 10: Проверка недостаточности средств
**Цель:** Проверить корректную обработку ошибок при недостатке средств

**Шаги:**
1. Установить `fund_dynamic` админа = 100
2. Попытаться пополнить кассу оператора на 200
3. Проверить, что выброшена ошибка "Недостаточно средств в фонде"
4. Проверить, что никаких изменений не произошло

**Ожидаемый результат:** Операция отклонена с корректной ошибкой, данные не изменились.

## Команды для тестирования

### Проверка текущего состояния фонда
```php
$admin = GpAdmin::first();
echo "Fund: " . $admin->fund . "\n";
echo "Fund Dynamic: " . $admin->fund_dynamic . "\n";
echo "Total Earn: " . $admin->total_earn . "\n";
echo "Is Balanced: " . ($admin->isFundBalanced() ? 'Yes' : 'No') . "\n";
echo "Difference: " . $admin->getFundDifference() . "\n";
```

### Проверка логов фонда
```sql
SELECT * FROM gp_admin_fund_logs ORDER BY created_at DESC LIMIT 10;
```

### Проверка баланса компании
```sql
SELECT id, name, credit_balance, balance, agregator_side_balance FROM gp_companies;
```

### Проверка кассы оператора
```sql
SELECT id, name, cash FROM gp_operators WHERE cashier = 1;
```

## Операции, которые НЕ влияют на фонд админа

Следующие операции **НЕ должны** изменять `fund_dynamic` или `total_earn`:

1. **Водитель закрывает заказ** - никаких изменений в фонде
2. **Водитель закрывает вызов** - никаких изменений в фонде  
3. **Оператор закрывает кассу** - никаких изменений в фонде ✅ **ИСПРАВЛЕНО**
4. **Увеличивается долг агрегатора** - никаких изменений в фонде ✅ **ИСПРАВЛЕНО**
5. **Оператор пополняет кредит компании** - `fund_dynamic` не изменяется

## Критерии успешного тестирования

1. **Все операции выполняются корректно** - изменения в базе данных соответствуют ожидаемым
2. **Логирование работает** - все операции записываются в соответствующие таблицы логов
3. **Фонд остается сбалансированным** - `fund = fund_dynamic + сумма всех credit_balance`
4. **Обработка ошибок** - при недостатке средств операции отклоняются корректно
5. **Нет дублирования** - каждая операция выполняется только один раз
6. **Консистентность данных** - все связанные таблицы обновляются синхронно
7. **Операции без влияния на фонд** - указанные выше операции не изменяют фонд админа
